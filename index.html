<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Synergy Tao Holistic Health Hub — Directory</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#2F6E4E; --brand-2:#0f766e; --ink:#0f172a; --ink-2:#334155; --muted:#64748b;
      --chip:#e6f1eb; --chip-ink:#1f4d36; --card:#fff; --bg:#f8fafc; --line:#e2e8f0;
      --btn:#eaf6ef; --btn-ink:#1f4d36;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--ink); background:var(--bg);
    }
    .wrap{max-width:1100px;margin:24px auto 80px;padding:0 16px}
    .topbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .title{font-size:28px;font-weight:800;margin:0}
    .lead{color:var(--muted);margin:8px 0 16px;max-width:900px}
    .admin-btn{margin-left:auto;padding:8px 12px;border-radius:12px;border:2px solid var(--brand);
      background:#fff;color:var(--brand);font-weight:700;cursor:pointer}
    .search-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:6px 0 14px}
    .search{flex:1;min-width:260px;padding:12px 14px;border-radius:12px;border:2px solid #cbd5e1;
      outline:0;font-size:16px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 16px}
    .chip{background:var(--chip);color:var(--chip-ink);border:1px solid #cfe3d8;border-radius:30px;
      padding:6px 10px;font-weight:600;cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
    .card{display:flex;gap:16px;background:var(--card);padding:16px;border-radius:14px;
      border:1px solid var(--line);box-shadow:0 6px 20px rgba(0,0,0,.06)}
    .logo{width:108px;height:108px;border-radius:12px;border:1px solid var(--line);object-fit:contain;background:#fff}
    .card h3{margin:0 0 6px;font-size:20px}
    .meta{color:var(--muted);font-size:14px;margin:0 0 8px}
    .tagrow{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
    .tag{background:#eef2ff;border:1px solid #e2e8f0;color:#374151;border-radius:30px;padding:4px 9px;font-size:12px}
    .btnrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:auto}
    .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;color:#111827;text-decoration:none;font-weight:600}
    .btn.brand{background:var(--btn);border-color:var(--brand);color:var(--btn-ink)}
    .smlink{display:inline-flex;align-items:center;gap:6px;padding:7px 10px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;color:#111827;text-decoration:none;font-weight:600}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:30px;background:#f1f5f9;border:1px solid #e2e8f0;color:#0f172a;font-weight:600}
    .result-count{color:var(--muted);margin:8px 0 4px}
    /* admin buttons from save script will sit bottom-right */
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1 class="title">Synergy Tao Holistic Health Hub — Directory</h1>
     <a class="admin-btn" href="https://synergytao.github.io/synergytaohub-directory/?admin=1"
   target="_blank" rel="noopener" title="Open admin mode in a new tab">Admin</a>
    </div>
    <p class="lead">Discover holistic &amp; complementary services across Telford and Shropshire — search by name, service, tags or town.</p>

    <div class="search-row">
      <input id="q" class="search" type="search" placeholder="Search by name, service or town…" />
      <span id="count" class="pill">0 result</span>
    </div>

    <div id="chips" class="chips" aria-label="Popular tags"></div>

    <div id="list" class="grid" role="list"></div>
  </div>

  <script>
    // ------- util
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const escapeHtml = s => String(s||"").replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[c]));

    // ------- render
    function renderDirectory(data){
      const list = $("#list");
      const q = $("#q").value.trim().toLowerCase();
      const terms = q.split(/\s+/).filter(Boolean);

      // filter
      let out = data.filter(e => {
        if (!e.live) return false;
        const hay = [
          e.name, e.primaryService, e.town,
          ...(e.tags||[]), ...(e.keywords||[])
        ].join(" ").toLowerCase();
        return terms.every(t => hay.includes(t));
      });

      // count
      $("#count").textContent = out.length + (out.length===1 ? " result" : " results");

      // build HTML
      list.innerHTML = out.map(e => {
        const logo = e.logo || "";
        const tags = (e.tags||[]).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join("");
        const socials = (e.socials||[]);
        const sBtns = socials.map(s => s && s.url ? `<a class="smlink" href="${escapeHtml(s.url)}" target="_blank" rel="noopener">${escapeHtml(s.label||s.name||'Link')}</a>` : "").join("");

        const webBtn   = e.website ? `<a class="btn" href="${escapeHtml(e.website)}" target="_blank" rel="noopener">Website</a>` : "";
        const emailBtn = e.email   ? `<a class="btn" href="mailto:${escapeHtml(e.email)}">Email</a>` : "";
        const callBtn  = e.phone   ? `<a class="btn brand" href="tel:${escapeHtml(e.phone)}">Call</a>` : "";
        const hubBtn   = e.hubProfile ? `<a class="btn" href="${escapeHtml(e.hubProfile)}" target="_blank" rel="noopener">View Hub Profile</a>` : "";

        return `
          <article class="card" role="listitem">
            ${logo ? `<img class="logo" src="${escapeHtml(logo)}" alt="${escapeHtml(e.name)} logo">` : `<div class="logo" aria-hidden="true"></div>`}
            <div style="display:flex;flex-direction:column;flex:1;min-width:0;">
              <h3>${escapeHtml(e.name)}</h3>
              <p class="meta">${escapeHtml(e.primaryService || "")}${e.town ? " · " + escapeHtml(e.town) : ""}</p>
              <div class="tagrow">${tags}</div>
              <div class="btnrow">
                ${webBtn}${emailBtn}${callBtn}${hubBtn}${sBtns}
              </div>
            </div>
          </article>
        `;
      }).join("");

      // send height to parent (for iframe auto-size)
      try {
        const h = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight);
        parent.postMessage({ type:"sth-dir-height", height:h }, "*");
      } catch {}
    }

    // ------- chips/tags
    function buildChips(data){
      const all = new Set();
      data.forEach(e => (e.tags||[]).forEach(t => all.add(t)));
      const top = Array.from(all).slice(0, 8);
      $("#chips").innerHTML = top.map(t => `<button class="chip" data-t="${escapeHtml(t)}">${escapeHtml(t)}</button>`).join("");
      $("#chips").addEventListener("click", (ev)=>{
        const b = ev.target.closest(".chip"); if(!b) return;
        const t = b.getAttribute("data-t");
        const q = $("#q");
        const cur = q.value.trim();
        q.value = cur ? `${cur} ${t}` : t;
        renderDirectory(window.rawData||[]);
      });
    }

    // ------- data loader
    async function loadDirectoryData(){
      try {
        const res = await fetch("data/directory.json?t="+Date.now(), { cache:"no-store" });
        if (!res.ok) throw new Error("HTTP "+res.status);
        const json = await res.json();
        window.rawData = Array.isArray(json) ? json : [];
        buildChips(window.rawData);
        renderDirectory(window.rawData);
      } catch(err){
        console.warn("Failed to load data/directory.json", err);
        window.rawData = window.rawData || [];
        renderDirectory(window.rawData);
      }
    }

    // search listeners
    document.addEventListener("DOMContentLoaded", ()=>{
      $("#q").addEventListener("input", ()=> renderDirectory(window.rawData||[]));
      loadDirectoryData();
    });
  </script>

  <!-- Admin helpers (only needed when ?admin=1 is present).
       Version query busts cache when you update the script. -->
  <script>
    (function(){ if (location.search.includes("admin=1")) {
      document.body.classList.add("is-admin");
      var s = document.createElement("script");
      s.src = "admin/save-to-github.js?v=2025-09-26-3";
      document.body.appendChild(s);
    }})();
  </script>

  <!-- Report height to parent on resize too -->
  <script>
    (function(){
      function report(){ try{
        const h = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight);
        parent.postMessage({ type:"sth-dir-height", height:h }, "*");
      }catch{}}
      window.addEventListener("load", report);
      try { new ResizeObserver(report).observe(document.body); } catch(_) {}
    })();
  </script>
</body>
</html>
